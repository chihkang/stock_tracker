name: Update Portfolio

on:
  schedule:
    - cron: '30 3 * * 1-5'  # 週一至週五 03:30 UTC (台灣時間 11:30)
    - cron: '30 5 * * 1-5'  # 週一至週五 05:30 UTC (台灣時間 13:30)
    - cron: '35 14 * * 1-5'  # 週一至週五 14:35 UTC (台灣時間 22:35)
    - cron: '30 21 * * 0-5' # 週一至週六 21:30 UTC (台灣時間隔日 05:30)
  workflow_dispatch:  # 允許手動觸發

env:
  GIST_ID: ${{ secrets.GIST_ID }}
  GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

jobs:
  update-portfolio:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          
      - name: Check environment
        run: |
          echo "Checking environment variables..."
          if [ -n "$GIST_ID" ]; then
            echo "GIST_ID is set"
          else
            echo "GIST_ID is not set"
          fi
          if [ -n "$GIST_TOKEN" ]; then
            echo "GIST_TOKEN is set"
          else
            echo "GIST_TOKEN is not set"
          fi
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          
      - name: Update portfolio
        run: |
          echo "Starting portfolio update..."
          python -m stock_tracker portfolio --debug
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/src
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-logs
          path: |
            logs/*.log
            *.log